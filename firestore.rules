/**
 * @fileoverview Firestore Security Rules for CruiseLink application.
 *
 * These rules are configured for a role-based access control system.
 * They grant specific permissions to 'admin', 'supervisor', 'manager', 'head-cook', and 'voyager' roles.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles
    function isSignedIn() {
      return request.auth != null;
    }

    function isVoyager(uid) {
      return exists(/databases/$(database)/documents/voyagers/$(uid));
    }

    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/roles_admin/$(uid));
    }

    function isSupervisor(uid) {
      // Supervisors are managed within the admin role for simplicity in this ruleset version
      return exists(/databases/$(database)/documents/roles_admin/$(uid));
    }

    function isManager(uid) {
      return exists(/databases/$(database)/documents/roles_manager/$(uid));
    }
    
    function isHeadCook(uid) {
      return exists(/databases/$(database)/documents/roles_head-cook/$(uid));
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // Voyagers: Can read/write their own data, but not other voyagers' data.
    match /voyagers/{voyagerId} {
      allow read, update, delete: if isSignedIn() && isOwner(voyagerId);
      allow create: if isSignedIn();
      
      // Subcollections for user-specific data
      match /{subcollection}/{docId} {
        allow read, write: if isSignedIn() && isOwner(voyagerId);
      }
    }
    
    // Roles collections for role-based access control checks.
    match /roles_admin/{uid} {
      allow read: if isAdmin(request.auth.uid);
      allow create: if isSignedIn() && isOwner(uid);
      allow write: if false; // Should be managed by a trusted backend process
    }
    match /roles_manager/{uid} {
       allow read: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
       allow create: if isSignedIn() && isOwner(uid);
       allow write: if false;
    }
     match /roles_head-cook/{uid} {
       allow read: if isAdmin(request.auth.uid) || isHeadCook(request.auth.uid);
       allow create: if isSignedIn() && isOwner(uid);
       allow write: if false;
    }

    // Publicly readable collections
    match /cateringItems/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin(request.auth.uid);
    }
    match /stationeryItems/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin(request.auth.uid) || isSupervisor(request.auth.uid);
    }
    match /movies/{movieId} {
      allow read: if isSignedIn();
      allow write: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
    }
    
    // Denormalized collections for admin/manager views
    match /allCateringOrders/{orderId} {
      allow read, write: if isAdmin(request.auth.uid) || isHeadCook(request.auth.uid);
    }
    match /allStationeryOrders/{orderId} {
      allow read, write: if isAdmin(request.auth.uid) || isSupervisor(request.auth.uid);
    }
    match /allResortMovieTickets/{ticketId} {
      allow read, write: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
    }
    match /allBeautySalonBookings/{bookingId} {
      allow read, write: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
    }
    match /allFitnessCenterBookings/{bookingId} {
      allow read, write: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
    }
    match /allPartyHallBookings/{bookingId} {
      allow read, write: if isAdmin(request.auth.uid) || isManager(request.auth.uid);
    }
    
    // Voyager messages/complaints
    match /messages/{messageId} {
      allow read: if isAdmin(request.auth.uid);
      allow create: if isSignedIn();
    }
  }
}
